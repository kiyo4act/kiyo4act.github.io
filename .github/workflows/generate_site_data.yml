# .github/workflows/generate_site_data.yml
name: Generate Site Data

on:
  push:
    branches:
      - main # あなたのメインブランチ名に合わせてください
    paths-ignore:
      - 'update-info.json'
      - 'profile-data.json'
      - 'index.html' # 自動生成されるindex.htmlの変更ではトリガーしない
      - 'README.md'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  generate-data:
    runs-on: ubuntu-latest
    env:
      TARGET_GH_USERNAME: ${{ vars.GH_USERNAME }} # リポジトリ変数から読み込み
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: pip install requests

      - name: Generate update-info.json
        run: |
          echo "{\"lastUpdated\": \"$(date -u +'%Y-%m-%dT%H:%M:%SZ')\"}" > update-info.json
          echo "Generated update-info.json:"
          cat update-info.json

      - name: Generate profile-data.json
        env:
          GH_TOKEN_FROM_WORKFLOW: ${{ secrets.GITHUB_TOKEN }}
          # TARGET_GH_USERNAME_FROM_WORKFLOW は TARGET_GH_USERNAME を使う (jobレベルenv)
        run: |
          python scripts/get_profile.py # get_profile.py は TARGET_GH_USERNAME_FROM_WORKFLOW を参照

      - name: Fill HTML template to generate index.html
        run: |
          # このステップの前に profile-data.json が生成されている必要がある
          python scripts/fill_template.py 
          echo "Generated index.html from template."

      - name: Commit and push if files changed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          
          files_to_commit=""
          # コミット対象ファイルを確認して追加
          if [ -f update-info.json ]; then files_to_commit="$files_to_commit update-info.json"; fi
          if [ -f profile-data.json ]; then files_to_commit="$files_to_commit profile-data.json"; fi
          if [ -f index.html ]; then files_to_commit="$files_to_commit index.html"; fi # index.html もコミット対象に
          
          if [ -n "$files_to_commit" ]; then
            echo "Files to commit: $files_to_commit"
            git add $files_to_commit
            if git diff --staged --quiet; then
              echo "No changes to generated files."
            else
              git commit -m "Automated: Update site data and index.html" # コミットメッセージ更新
              git push
              echo "Updated files have been pushed to the repository."
            fi
          else
            echo "No files were generated or found to commit."
          fi
